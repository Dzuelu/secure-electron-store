"use strict";var _msgpack=require("@msgpack/msgpack");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.useConfigInMainResponse=exports.useConfigInMainRequest=exports.savePasskeyResponse=exports.savePasskeyRequest=exports.deleteConfigResponse=exports.deleteConfigRequest=exports.writeConfigResponse=exports.readConfigResponse=exports.writeConfigRequest=exports.readConfigRequest=void 0;function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var crypto=require("crypto"),path=require("path"),defaultOptions={debug:!1,minify:!0,encrypt:!0,passkey:"",path:"",filename:"data",extension:".json",reset:!1},readConfigRequest="ReadConfig-Request";exports.readConfigRequest=readConfigRequest;var writeConfigRequest="WriteConfig-Request";exports.writeConfigRequest="WriteConfig-Request";var readConfigResponse="ReadConfig-Response";exports.readConfigResponse="ReadConfig-Response";var writeConfigResponse="WriteConfig-Response";exports.writeConfigResponse="WriteConfig-Response";var deleteConfigRequest="DeleteConfig-Request";exports.deleteConfigRequest="DeleteConfig-Request";var deleteConfigResponse="DeleteConfig-Response";exports.deleteConfigResponse="DeleteConfig-Response";var savePasskeyRequest="SavePasskey-Request";exports.savePasskeyRequest="SavePasskey-Request";var savePasskeyResponse="SavePasskey-Response";exports.savePasskeyResponse="SavePasskey-Response";var useConfigInMainRequest="UseConfigInMain-Request";exports.useConfigInMainRequest="UseConfigInMain-Request";var useConfigInMainResponse="UseConfigInMain-Response";exports.useConfigInMainResponse="UseConfigInMain-Response";var generateIv=function(){return crypto.randomBytes(32).toString("hex").slice(0,16)},Store=function(){function a(b){_classCallCheck(this,a),this.options=defaultOptions,this.fileData=void 0,this.initialFileData=void 0,this.initialFileDataParsed=!1,this.iv=void 0,this.ivFile;if(this.mainLog="".concat("[secure-electron-store:","main]=>"),this.rendererLog="".concat("[secure-electron-store:","renderer]=>"),"undefined"!=typeof b&&(this.options=Object.assign(this.options,b)),"undefined"==typeof b||b.path!==defaultOptions.path)try{var c=process.argv.filter(function(a){return 0<=a.indexOf("storePath:")})[0];this.options.path=c.substr(c.indexOf(":")+1),this.options.debug&&console.log("".concat(this.rendererLog," initializing. Parsed 'storePath' value: '").concat(this.options.path,"'."))}catch(a){throw"Could not find property 'additionalArguments' value beginning with 'storePath:' in your BrowserWindow. Please ensure this is set! Error: ".concat(a)}this.ivFile=path.join(this.options.path,"iv.txt"),this.options.path=path.join(this.options.path,"".concat(this.options.filename).concat(this.options.extension)),this.validSendChannels=[readConfigRequest,writeConfigRequest,savePasskeyRequest,deleteConfigRequest,useConfigInMainRequest],this.validReceiveChannels=[readConfigResponse,writeConfigResponse,savePasskeyResponse,deleteConfigResponse,useConfigInMainResponse],this.options.debug&&("object"===("undefined"==typeof process?"undefined":_typeof(process))&&0===process.argv.filter(function(a){return 0<=a.indexOf("electron")}).length?console.log("".concat(this.rendererLog," initialized store. Data file: '").concat(this.options.path,"'.")):console.log("".concat(this.mainLog," initialized store. Data file: '").concat(this.options.path,"'.")))}return _createClass(a,[{key:"getIv",value:function getIv(a){if("undefined"!=typeof this.iv)return!0;var b;try{b=a.readFileSync(this.ivFile)}catch(d){var c=generateIv();b=c,"ENOENT"!==d.code&&(debug?console.warn(d):null),a.writeFileSync(this.ivFile,c)}this.iv=b}},{key:"preloadBindings",value:function preloadBindings(a,b){var c=this,d=this.options,e=d.minify,f=d.debug,g=d.encrypt,h=d.path;try{this.initialFileData=b.readFileSync(h)}catch(a){if("ENOENT"===a.code){var i={};if(i=e?(0,_msgpack.encode)(i):JSON.stringify(i),g){this.getIv(b);var j=crypto.createCipheriv("aes-256-cbc",crypto.createHash("sha512").update(this.options.passkey).digest("base64").substr(0,32),this.iv);i=Buffer.concat([j.update(i),j.final()])}this.initialFileData={},this.initialFileDataParsed=!0,b.writeFileSync(h,i)}else throw"".concat(this.rendererLog," encountered error '").concat(a,"' when trying to read file '").concat(h,"'. This file is probably corrupted. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}return{path:h,setPasskey:function setPasskey(b){c.options.passkey=b,a.send(savePasskeyRequest,{passkey:b})},initial:function initial(){if(c.initialFileDataParsed)return c.initialFileData;f?console.log("".concat(c.rendererLog," reading data from file '").concat(h,"' into the 'initial' property.")):null;try{if(g){c.getIv(b);var a=crypto.createDecipheriv("aes-256-cbc",crypto.createHash("sha512").update(c.options.passkey).digest("base64").substr(0,32),c.iv);c.initialFileData=Buffer.concat([a.update(c.initialFileData),a.final()])}c.initialFileData=e?(0,_msgpack.decode)(c.initialFileData):JSON.parse(c.initialFileData)}catch(a){throw"".concat(c.rendererLog," encountered error '").concat(a,"' when trying to read file '").concat(h,"'. This file is probably corrupted or has been tampered with. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}return c.initialFileDataParsed=!0,c.initialFileData},send:function send(b,d,e){if(c.validSendChannels.includes(b))switch(b){case readConfigRequest:f?console.log("".concat(c.rendererLog," requesting to read key '").concat(d,"' from file.")):null,a.send(b,{key:d});break;case writeConfigRequest:f?console.log("".concat(c.rendererLog," requesting to write key:value to file => \"'").concat(d,"':'").concat(e,"'\".")):null,a.send(b,{key:d,value:e});break;case savePasskeyRequest:f?console.log("".concat(c.rendererLog," requesting to save passkey '").concat(d,"' to file.")):null,a.send(b,{key:d});break;case deleteConfigRequest:f?console.log("".concat(c.rendererLog," requesting to delete file.")):null,a.send(b,{});break;case useConfigInMainRequest:f?console.log("".concat(c.rendererLog," requesting to use store in electron main process.")):null,a.send(b,{});break;default:}},onReceive:function onReceive(b,d){c.validReceiveChannels.includes(b)&&a.on(b,function(a,e){if(f)switch(b){case readConfigResponse:console.log("".concat(c.rendererLog," received value for key '").concat(e.key,"' => '").concat(e.value,"'."));break;case writeConfigResponse:console.log("".concat(c.rendererLog," ").concat(e.success?"":"un-","successfully wrote key '").concat(e.key,"' to file."));break;case savePasskeyResponse:console.log("".concat(c.rendererLog," ").concat(e.success?"":"un-","successfully saved passkey."));break;case deleteConfigResponse:console.log("".concat(c.rendererLog," ").concat(e.success?"":"un-","successfully deleted file."));break;case useConfigInMainResponse:console.log("".concat(c.rendererLog," ").concat(e.success?"":"un-","successfully read store in electron main process."));break;default:}b===deleteConfigResponse&&e.success&&(c.iv=void 0),d(e)})},clearRendererBindings:function clearRendererBindings(){f?console.log("".concat(c.rendererLog," clearing all ipcRenderer listeners.")):null;for(var b=0;b<c.validReceiveChannels.length;b++)a.removeAllListeners(c.validReceiveChannels[b])}}}},{key:"mainBindings",value:function mainBindings(a,b,c){var d=this,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0,f=this.options,g=f.minify,h=f.debug,i=f.encrypt,j=f.path,k=f.reset,l=function(){h?console.log("".concat(this.mainLog," clearing data files.")):null,c.writeFileSync(j,""),c.writeFileSync(this.ivFile,""),h?console.log("".concat(this.mainLog," unlinking data files.")):null,c.unlinkSync(j),c.unlinkSync(this.ivFile),h?console.log("".concat(this.mainLog," clearing local variables.")):null,this.iv=void 0,this.fileData=void 0}.bind(this);if(k){h?console.log("".concat(this.mainLog," resetting all files because property \"reset\" was set to true when configuring the store.")):null;try{l()}catch(a){throw"".concat(this.mainLog," could not reset files, please resolve error '").concat(a,"' and try again.")}}a.on(deleteConfigRequest,function(){h?console.log("".concat(d.mainLog," received a request to delete data files.")):null;var a=!0;try{l()}catch(b){console.error("".concat(d.mainLog," failed to reset data due to error: '").concat(b,"'. Please resolve this error and try again.")),a=!1}b.webContents.send(deleteConfigResponse,{success:a})}),a.on(savePasskeyRequest,function(a,c){h?console.log("".concat(d.mainLog," received a request to update the passkey to '").concat(c.passkey,"'.")):null,d.options.passkey=c.passkey,b.webContents.send(savePasskeyResponse,{success:!0})}),a.on(readConfigRequest,function(a,e){h?console.log("".concat(d.mainLog," received a request to read from the key '").concat(e.key,"' from the given file '").concat(j,"'.")):null,c.readFile(j,function(a,f){if(a){if("ENOENT"===a.code){h?console.log("".concat(d.mainLog," did not find data file when trying read the key '").concat(e.key,"'. Creating an empty data file.")):null;var l={};if(l=g?(0,_msgpack.decode)(l):JSON.parse(l),i){d.getIv(c);var m=crypto.createCipheriv("aes-256-cbc",crypto.createHash("sha512").update(d.options.passkey).digest("base64").substr(0,32),d.iv);l=Buffer.concat([m.update(l),m.final()])}return c.writeFileSync(j,l),void b.webContents.send(readConfigResponse,{success:!1,key:e.key,value:void 0})}throw"".concat(d.mainLog," encountered error '").concat(a,"' when trying to read file '").concat(j,"'. This file is probably corrupted. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}var k=f;try{if(i){d.getIv(c);var n=crypto.createDecipheriv("aes-256-cbc",crypto.createHash("sha512").update(d.options.passkey).digest("base64").substr(0,32),d.iv);k=Buffer.concat([n.update(k),n.final()])}k=g?(0,_msgpack.decode)(k):JSON.parse(k)}catch(a){throw"".concat(d.mainLog," encountered error '").concat(a,"' when trying to read file '").concat(j,"'. This file is probably corrupted or has been tampered with. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}d.fileData=k,h?console.log("".concat(d.mainLog," read the key '").concat(e.key,"' from file => '").concat(k[e.key],"'.")):null,b.webContents.send(readConfigResponse,{success:!0,key:e.key,value:k[e.key]})})}),a.on(writeConfigRequest,function(a,e){var f=function(){var a=this;"undefined"!=typeof e.key&&"undefined"!=typeof e.value&&(this.fileData[e.key]=e.value);var d=this.fileData;try{if(d=g?(0,_msgpack.encode)(d):JSON.stringify(d),i){this.getIv(c);var f=crypto.createCipheriv("aes-256-cbc",crypto.createHash("sha512").update(this.options.passkey).digest("base64").substr(0,32),this.iv);d=Buffer.concat([f.update(d),f.final()])}}catch(a){throw"".concat(this.mainLog," encountered error '").concat(a,"' when trying to write file '").concat(j,"'.")}c.writeFile(j,d,function(c){h?console.log("".concat(a.mainLog," wrote \"'").concat(e.key,"':'").concat(e.value,"'\" to file '").concat(j,"'.")):null,b.webContents.send(writeConfigResponse,{success:!c,key:e.key})})}.bind(d);"undefined"==typeof d.fileData?c.readFile(j,function(a,b){if(a){if("ENOENT"===a.code)return d.fileData={},void f();throw"".concat(d.mainLog," encountered error '").concat(a,"' when trying to read file '").concat(j,"'. This file is probably corrupted. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}var e=b;try{if("undefined"!=typeof b){if(i){d.getIv(c);var h=crypto.createDecipheriv("aes-256-cbc",crypto.createHash("sha512").update(d.options.passkey).digest("base64").substr(0,32),d.iv);e=Buffer.concat([h.update(e),h.final()])}e=g?(0,_msgpack.decode)(e):JSON.parse(e)}}catch(a){throw"".concat(d.mainLog," encountered error '").concat(a,"' when trying to read file '").concat(j,"'. This file is probably corrupted. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}d.fileData=e,f()}):f()}),a.on(useConfigInMainRequest,function(){if(h?console.log("".concat(d.mainLog," received a request to read store in electron main process.")):null,"undefined"!=typeof e){var a={};c.readFile(j,function(f,k){if(f&&"ENOENT"===f.code)return h?console.log("".concat(d.mainLog," did not find data file when trying read the data file from the main electron process.")):null,e(!1,a),void b.webContents.send(useConfigInMainResponse,{success:!1});a=k;try{if(i){d.getIv(c);var l=crypto.createDecipheriv("aes-256-cbc",crypto.createHash("sha512").update(d.options.passkey).digest("base64").substr(0,32),d.iv);a=Buffer.concat([l.update(a),l.final()])}a=g?(0,_msgpack.decode)(a):JSON.parse(a)}catch(a){throw"".concat(d.mainLog," encountered error '").concat(a,"' when trying to read file '").concat(j,"'. This file is probably corrupted or has been tampered with. To fix this error, you may set \"reset\" to true in the options in your main process where you configure your store, or you can turn off your app, delete (recommended) or fix this file and restart your app to fix this issue.")}return h?console.log("".concat(d.mainLog," read the store from the electron main process successfully.")):null,e(!0,a),void b.webContents.send(useConfigInMainResponse,{success:!0})})}else throw"".concat(d.mainLog," failed to take action when receiving a request to use the store in the main electron process. This has occurred because your callback is undefined, please ensure your callback is \"const\" so it is not garbage collected - this is the most likely reason for your error")})}},{key:"clearMainBindings",value:function clearMainBindings(a){a.removeAllListeners(readConfigRequest),a.removeAllListeners(writeConfigRequest),a.removeAllListeners(deleteConfigRequest),a.removeAllListeners(savePasskeyRequest),a.removeAllListeners(useConfigInMainRequest)}}]),a}();exports["default"]=Store;